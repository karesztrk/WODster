@(currentPage: dao.AbstractDAO.Page[model.training.Workout], currentSortBy: String, currentOrder: String, currentFilter: String, attendForm: Form[model.training.result.Attendance])

@import helper._
@import util.permission.Identity
@import controllers.WODController
@implicitFieldConstructor = @{ FieldConstructor(component.bootstrapInput.render) }
@authenticated = @{Identity.isAuthenticated()}
@import model.training.Workout.ResultMeasurementType

@main("wod") {
    
    <div class="layout layout-stack-sm layout-main-left">
    
    	<!-- Main -->
    	<div class="col-sm-7 col-md-8 layout-main">
    		
    		@for(post <- currentPage.getList) {
				<div class="post-entry">
					
					<div title="" class="post-attended ui-tooltip" data-original-title="This workout is done!">
	                	<i class="fa fa-check"></i>
	                </div>
					
					<div class="post-header">
                    	<h4 class="post-title"><u>@post.title</u></h4>
            		</div>
                
	                <div class="post-date">
	                  <!-- Date/Time -->
							<span class="glyphicon glyphicon-time"></span> Posted on @post.date.format(util.Configuration.DATETIME_PATTERN)
	                </div>
					
					
					<div class="post-content">
						
						<!-- Preview Image -->
						@if(util.asset.AssetUtils.isFileExist(post.image)) {
							<img alt="Post image" src="@routes.Assets.at(post.image)" class="img-responsive img-centered">
							
							<hr>
						} 
						
						<!-- Post Content -->
						<div >@Html(post.content)</div>
						
						<hr>
						
						@if(authenticated) {
						
							@if(WODController.isAttendee(post)) {
								<button disabled="disabled" type="button" data-value="@post.id" class="btn btn-success btn-attended">Done&nbsp;<i class="glyphicon glyphicon-ok"></i></button>
							} else {
								<button type="button" data-wod-id="@post.id" data-wod-type="@post.resultType" class="btn btn-primary btn-attend" data-toggle="modal" data-target="#attendModal">Done</button>
							}
						}
						
						<a href="/workouts/@post.id" class="btn btn-secondary">Read More <span class="glyphicon glyphicon-chevron-right"></span></a>

					</div>
				</div>
		    }
    	
    	</div>
    	
    	<!-- Sidebar -->
    	<div class="col-sm-5 col-md-4 layout-sidebar">
    	
    		<div class="portlet">
    			
    			@if(authenticated) {
					<a href="@routes.WODController.create()" class="btn btn-primary btn-jumbo btn-block ">New WOD</a>
				}
    			
    		</div>
    	</div>
    
    </div>
		<!--  Add this to the navbar after all
	    <div class="col-md-4">
			<div class="well">
			    <h4>WOD Search</h4>
			    @form(routes.WODController.list(0, "", "", ""), 'method -> "GET") {
				    <div class="input-group">
				        <input type="search" name="f" class="form-control" placeholder="Filter by title..." value="@currentFilter">
				        <span class="input-group-btn">
				            <input type="submit" class="btn btn-default" value="Search">
				                <span class="glyphicon glyphicon-search"></span>
				        	</input>
				        </span>
				    </div>
				}
			</div>
	    </div>
	    -->
	
	<div class="modal fade" id="attendModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
					<h4 class="modal-title" id="myModalLabel">Attend</h4>
				</div>
				@form(routes.WODController.attend(), 'id -> "attendForm", 'class -> "form parsley-form", Symbol("data-validate") -> "parsley") {
					<div class="modal-body">
						<input type="hidden" name="wodId" id="wodId" value="" />
						
						@component.datePicker(attendForm("date"), '_label -> "Workout date:", 'class -> "form-control", '_showHelp -> false)
						@component.timePicker(attendForm("timeResult"), '_label -> "Your result:", 'class -> "form-control", 'placeholder -> "Pick your result time...", '_showHelp -> false, 'style -> "display: none;")
						@inputText(attendForm("result"), '_label -> "Your result:", 'class -> "form-control parsley-validated", Symbol("data-type") -> "digits", 'placeholder -> "Add your result...", '_showHelp -> false, 'style -> "display: none;") 
						@textarea(attendForm("note"), '_label -> null, 'placeholder -> "Add a note...", 'class -> "form-control")
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
						<button type="submit" class="btn btn-primary">Save changes</button>
					</div>
				}
			</div>
		</div>
	</div>
	
	<script type="text/javascript">
		/*$("div.post_content").text(function(index, currentText) {
			
			var charLimit = 100;
			if(currentText.length > charLimit) {
				var content = currentText.substr(0, 100);
			    return currentText.substr(0, 100) + '...';
			}
			
			return currentText;
		});*/
		
		$(document).ready(function()
		{
			$(".btn.btn-primary.btn-attend").click(function()
				{
					var btn = $(this);
					var id = btn.attr('data-wod-id');
					var type = btn.attr('data-wod-type');
					$("#wodId").val(id);
					
					if('TIME' == type) {
						var elem = $("#result");
						elem.closest(".form-group").children().attr('style','display:none !important');
						//$("label[for='result']").hide();
						
						var elem = $("#timeResult");
						elem.closest(".form-group").children().show();
						//$("label[for='timeResult']").show();
					} else {
						var elem = $("#result");
						//$("label[for='result']").show();
						elem.closest(".form-group").children().show();
						
						var elem = $("#timeResult");
						//$("label[for='timeResult']").hide();
						elem.closest(".form-group").children().attr('style','display:none !important');
					}
				});
			
			$("#attendForm").submit(function(e)
				{
					var form = $(this);
					var formData = form.serializeArray();
					var formURL = form.attr("action");
					
					// stop the form from submitting the normal way and refreshing the page
					e.preventDefault();
					if (form.parsley().isValid()) {
						$.ajax(
						{
							url : formURL,
							type: "POST",
							data : formData,
							success: function(data, textStatus, jqXHR)
							{
								var btn = $("button[data-wod-id=" + formData[0].value + "]");
								if(!btn.hasClass('btn-success')) {
									btn.addClass('btn-success').attr('disabled', 'disabled')
										.append('&nbsp;')
									    .append($('<i></i>')
								        .addClass('glyphicon glyphicon-ok')
								    )
								}
								$('#attendModal').modal('hide');
								form.trigger("reset");
							},
							error: function(jqXHR, textStatus, errorThrown)
							{
								// TODO
								alert('Error ' + textStatus + ' ' + errorThrown);
							}
						});
					}
				});
		});
	</script>
}

            