@(currentPage: dao.AbstractDAO.Page[model.training.Workout], currentSortBy: String, currentOrder: String, currentFilter: String, attendForm: Form[model.result.Attendance])

@import helper._
@import util.permission.Identity
@import controllers.WODController
@implicitFieldConstructor = @{ FieldConstructor(component.bootstrapInput.render) }
@authenticated = @{Identity.isAuthenticated()}

@main("wod") {
    
    <div class="row">
    
    	<div class="col-md-8">
    		<h1>WODs</h1>
    		
    		@if(authenticated) {
				<a href="/workouts/new" class="btn btn-primary">Add new <span class="glyphicon glyphicon-plus"></span></a>
			}
    	
	    	@for(post <- currentPage.getList) {

				<!-- Title -->
				<h2>@post.title</h2>
				
				<!-- Author -->
				<p class="lead">
				    by <a href="#">@post.user.name</a>
				</p>
				
				<hr>
				
				<!-- Date/Time -->
				<p><span class="glyphicon glyphicon-time"></span> Posted on @post.date.format("yyyy.MM.dd 'at' HH:mm:ss") </p>
				
				<hr>
				
				<!-- Preview Image -->
				@if(util.asset.AssetUtils.isFileExist(post.image)) {
					<img alt="Post image" src="@routes.Assets.at(post.image)" class="img-responsive img-centered">
					
					<hr>
				} 
				
				<!-- Post Content -->
				<div class="post_content">@Html(post.content)</div>
				
				<hr>
				
				@if(authenticated) {
				
					@if(WODController.isAttendee(post)) {
						<button disabled="disabled" type="button" data-value="@post.id" class="btn btn-success btn-attended">Done&nbsp;<i class="glyphicon glyphicon-ok"></i></button>
					} else {
						<button type="button" data-value="@post.id" class="btn btn-primary btn-attend" data-toggle="modal" data-target="#attendModal">Done</button>
					}
				}
				
				<a href="/workouts/@post.id" class="btn btn-primary">Read More <span class="glyphicon glyphicon-chevron-right"></span></a>
				
				<hr>
		    }
		    
	    </div>

		<!--  Add this to the navbar after all
	    <div class="col-md-4">
			<div class="well">
			    <h4>WOD Search</h4>
			    @form(routes.WODController.list(0, "", "", ""), 'method -> "GET") {
				    <div class="input-group">
				        <input type="search" name="f" class="form-control" placeholder="Filter by title..." value="@currentFilter">
				        <span class="input-group-btn">
				            <input type="submit" class="btn btn-default" value="Search">
				                <span class="glyphicon glyphicon-search"></span>
				        	</input>
				        </span>
				    </div>
				}
			</div>
	    </div>
	    -->
	</div>
	
	<div class="modal fade" id="attendModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
					<h4 class="modal-title" id="myModalLabel">Attend</h4>
				</div>
				@form(routes.WODController.attend(), 'id -> "attendForm") {
					<div class="modal-body">
						<input type="hidden" name="postId" id="postId" value="" />
						@textarea(attendForm("note"), '_label -> null, 'placeholder -> "Add a note...", 'class -> "form-control")
						@inputDate(attendForm("date"), '_label -> null, 'class -> "form-control")
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
						<button type="submit" class="btn btn-primary">Save changes</button>
					</div>
				}
			</div>
		</div>
	</div>
	
	<script type="text/javascript">
		/*$("div.post_content").text(function(index, currentText) {
			
			var charLimit = 100;
			if(currentText.length > charLimit) {
				var content = currentText.substr(0, 100);
			    return currentText.substr(0, 100) + '...';
			}
			
			return currentText;
		});*/
		
		$(document).ready(function()
		{
			$(".btn.btn-primary.btn-attend").click(function()
				{
					var btn = $(this);
					var data = btn.attr('data-value');
					$("#postId").val(data);
				});
			
			$("#attendForm").submit(function(e)
				{
					var form = $(this);
					var formData = form.serializeArray();
					var formURL = form.attr("action");
					$.ajax(
					{
						url : formURL,
						type: "POST",
						data : formData,
						success: function(data, textStatus, jqXHR)
						{
							var btn = $("button[data-value=" + formData[0].value + "]");
							if(!btn.hasClass('btn-success')) {
								btn.addClass('btn-success').attr('disabled', 'disabled')
									.append('&nbsp;')
								    .append($('<i></i>')
							        .addClass('glyphicon glyphicon-ok')
							    )
							}
							$('#attendModal').modal('hide');
							form.trigger("reset");
						},
						error: function(jqXHR, textStatus, errorThrown)
						{
							// TODO
							alert('Error ' + textStatus + ' ' + errorThrown);
						}
					});
					
					// stop the form from submitting the normal way and refreshing the page
					e.preventDefault();
				});
		});
	</script>
}

            